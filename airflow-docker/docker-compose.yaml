version: "3.8"

x-airflow-common: &airflow-common
  build:
    context: ..
    dockerfile: airflow-docker/Dockerfile
  environment:
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    FINANCE_SCRIPT_ROOT_PATH: /app/scraper/src
    FINANCE_DATA_TRADINGVIEW_SCRAPER_PATH: /data/tradingview
    CASSANDRA_HOST: cassandra
    CASSANDRA_PORT: 9042
    AIRFLOW_UID: 50000
  volumes:
    - ./dags:/opt/airflow/dags
    - tradingview-data:/data/tradingview
    - ./scraper:/app/scraper
  user: "${AIRFLOW_UID:-50000}:0"
  depends_on:
    - cassandra

services:
  airflow-init:
    build:
      context: ..
      dockerfile: airflow-docker/Dockerfile
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      FINANCE_SCRIPT_ROOT_PATH: /app/scraper/src
      FINANCE_DATA_TRADINGVIEW_SCRAPER_PATH: /data/tradingview
      CASSANDRA_HOST: cassandra
      CASSANDRA_PORT: 9042
      AIRFLOW_UID: 50000
      _AIRFLOW_DB_MIGRATE: "true"
      _AIRFLOW_WWW_USER_CREATE: "true"
      _AIRFLOW_WWW_USER_USERNAME: "${_AIRFLOW_WWW_USER_USERNAME:-airflow}"
      _AIRFLOW_WWW_USER_PASSWORD: "${_AIRFLOW_WWW_USER_PASSWORD:-airflow}"
    volumes:
      - ./dags:/opt/airflow/dags
      - tradingview-data:/data/tradingview
      - ./scraper:/app/scraper
    user: "${AIRFLOW_UID:-50000}:0"
    depends_on:
      - cassandra
    entrypoint: /bin/bash
    command: -c "airflow db init && airflow users create --username airflow --password airflow --role Admin --email airflow@example.com"

  cassandra:
    image: cassandra:4.1
    ports:
      - "9042:9042"
    volumes:
      - cassandra-data:/var/lib/cassandra
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "describe keyspaces"]
      interval: 10s
      timeout: 5s
      retries: 10

  airflow-webserver:
    build:
      context: ..
      dockerfile: airflow-docker/Dockerfile
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      FINANCE_SCRIPT_ROOT_PATH: /app/scraper/src
      FINANCE_DATA_TRADINGVIEW_SCRAPER_PATH: /data/tradingview
      CASSANDRA_HOST: cassandra
      CASSANDRA_PORT: 9042
      AIRFLOW_UID: 50000
    volumes:
      - ./dags:/opt/airflow/dags
      - tradingview-data:/data/tradingview
      - ./scraper:/app/scraper
    user: "${AIRFLOW_UID:-50000}:0"
    command: webserver
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: always
    depends_on:
      - cassandra
      - airflow-init

  airflow-scheduler:
    build:
      context: ..
      dockerfile: airflow-docker/Dockerfile
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      FINANCE_SCRIPT_ROOT_PATH: /app/scraper/src
      FINANCE_DATA_TRADINGVIEW_SCRAPER_PATH: /data/tradingview
      CASSANDRA_HOST: cassandra
      CASSANDRA_PORT: 9042
      AIRFLOW_UID: 50000
    volumes:
      - ./dags:/opt/airflow/dags
      - tradingview-data:/data/tradingview
      - ./scraper:/app/scraper
    user: "${AIRFLOW_UID:-50000}:0"
    command: scheduler
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8974/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: always
    depends_on:
      - cassandra
      - airflow-init

  airflow-cli:
    build:
      context: ..
      dockerfile: airflow-docker/Dockerfile
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      FINANCE_SCRIPT_ROOT_PATH: /app/scraper/src
      FINANCE_DATA_TRADINGVIEW_SCRAPER_PATH: /data/tradingview
      CASSANDRA_HOST: cassandra
      CASSANDRA_PORT: 9042
      AIRFLOW_UID: 50000
      CONNECTION_CHECK_MAX_COUNT: "0"
    volumes:
      - ./dags:/opt/airflow/dags
      - tradingview-data:/data/tradingview
      - ./scraper:/app/scraper
    user: "${AIRFLOW_UID:-50000}:0"
    profiles:
      - debug
    command:
      - bash
      - -c
      - airflow

volumes:
  tradingview-data:
  cassandra-data:
